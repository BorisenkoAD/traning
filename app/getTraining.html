<?php
require "conectdb.php";
$message = "";
$id = $_COOKIE['user_id'];
$date_today = date("Y-m-d"); //присвоено 2018-03-16

if(isset($_POST['submit_date'])){
    $InputDateStart = substr(htmlspecialchars(trim($_POST['InputDateStart'])), 0, 25);
    $InputDateEnd = substr(htmlspecialchars(trim($_POST['InputDateEnd'])), 0, 25);
    $allTraning_benchPress = R::find('training', "user_id = ? AND date_insert >= ? AND date_insert <= ? order by date_insert, movement", array($id, $InputDateStart, $InputDateEnd));    
    if(empty($allTraning_benchPress)) {
        $message = "на эти дни тренировок нет!! Смотри все, что есть!!";
    }
} else { $allTraning_benchPress = R::find('training', "user_id = ? AND date_insert = ? order by date_insert, movement", array($id, $date_today));}

if(empty($allTraning_benchPress)) {
    $allTraning_benchPress = R::find('training', "user_id = ? AND date_insert < ? order by date_insert, movement", array($id, $date_today));}

if (empty($_COOKIE['username'])) {
    header("Location: http://" . $_SERVER['HTTP_HOST']);}
?>
    <!DOCTYPE html>
    <html lang="ru">

    <head>
        <meta charset="utf-8">
        <base href="/">

        <title>View training session</title>
        <meta name="description" content="">

        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

        <!-- Template Basic Images Start -->
        <meta property="og:title" content="мой тренировочный дневник" />
        <meta property="og:description" content="Эта программа создана с целью начать уже хранить все свои тренировки где - то в одном месте."
        />
        <meta property="og:image" content="img/og_image.jpg">
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://77.244.220.168/" />

        <link rel="shortcut icon" href="img/favicon/favicon.png" type="image/x-icon" />
        <link rel="apple-touch-icon" href="img/favicon/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="img/favicon/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="img/favicon/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="76x76" href="img/favicon/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="img/favicon/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="120x120" href="img/favicon/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="img/favicon/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon" sizes="152x152" href="img/favicon/apple-touch-icon-152x152.png" />
        <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon-180x180.png" />
        <!-- Template Basic Images End -->

        <!-- Custom Browsers Color Start -->
        <meta name="theme-color" content="#000">
        <!-- Custom Browsers Color End -->

        <link rel="stylesheet" href="css/main.min.css">

    </head>

    <body class="text-center">

        <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
            <header class="">
                <nav class="navbar navbar-expand-lg navbar-light">
                    <a class="navbar-brand" href="#">                                           
                        <p class="masthead-brand">Hello,
                            <?php echo $_COOKIE['username'];?>
                        </p>
                    </a>
                </nav>   
            </header>
            <main role="main" class="inner cover">
                <p>Показывается тренировка на текущую дату.
                    <br/>Если сегодня трени нет, то показываются все даты.</p>
                <h3 class="cover-heading">
                    <a href="#date" class="btn btn-outline-light popup-with-form">Выбор даты</a>
                </h3>
                <h4>
                    <?php echo $message; ?>
                </h4>
                <div class="container-fluid">

                    <?php 
                    //  попытка разделить тренировки линией
                        $currentDate = "";
                        $prevDate = "";
                         foreach($allTraning_benchPress as $traning){ 
                                $currentDate = $traning->date_insert; 
                                if ($currentDate == $prevDate) {} else {?>
                    <hr />
                    <?php 
                                    $prevDate = $currentDate;
                                }
                            $prevDate = $traning->date_insert;   

                            $currentDate = strtotime($currentDate); // переводит из строки в дату
                            $currentDateMonDay = date("d M", $currentDate); // переводит в новый формат
                            ?>
                    <div class="row">
                        <div class="col">
                            <?php echo "$traning->movement"?>:</div>
                        <div class="col">
                            <?php echo "$traning->weight"?> кг x
                            <?php echo "$traning->repeat"?> x
                            <?php echo "$traning->approach"?>
                        </div>
                        <div class="col">
                            <?php echo $currentDateMonDay?>
                        </div>
                        <div class="col">
                            <a href="delSet.php?id=<?php echo " $traning->id"?>">
                                <i class="far fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                    <?php                        
                        }?>
                </div>
            </main>
            <footer class="mastfoot mt-auto">
                <div class="inner">
                    <p>Моя тренировка. Все права зареганы.<?php if(!empty($_COOKIE['username'])) {?> <a class="nav-link" href="exit.php" style="color:brown"> Exit</a></p> <?php }?>
                </div>
            </footer>
        </div>
        <form id="date" class="white-popup-block mfp-hide" action="" method="POST">
            <div class="form-row align-items-center">
                <div class="col">
                    <input type="date" class="form-control" id="InputDateStart" name="InputDateStart">
                </div>
                <div class="col">
                    <input type="date" class="form-control" id="InputDateEnd" name="InputDateEnd">
                </div>
                <div class="col">
                    <button type="submit" name="submit_date" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
        <script src="js/scripts.min.js"></script>
    </body>

    </html>